{% extends "base.html" %}

{% load admin_urls %}
{% load url from future %}

{% block title %}{% if query_string %}
   {% with total=works|length %}
   {{ total }} oeuvre{{ total|pluralize }} correspondant à "{{ query_string }}"
   {% endwith %}
   {% else %}
   {{ "Liste des oeuvres" }}
   {% endif %}{% endblock %}
{% block extra_header %}
    <link href="{{ STATIC_URL }}css/michaux-grid.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="{{ STATIC_URL }}css/jquery-ui.css" rel="stylesheet" type="text/css" media="screen" />
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui.js"></script>
    <script type="text/javascript">
      resetFilter = function () {
          f = $("#filter")[0];
          f.value = "";
          f.form.submit()
      }

      $(function() {
          var range = $("[data-start]").map( function () { var a = $(this).attr("data-start"); if (a != "None") return parseInt(a); } )
          if (range.length > 0) {
              var min = Math.min.apply(Math, range);
              var max = Math.max.apply(Math, range);

              $( "#slider-range" ).slider({
                  range: true,
                  min: min,
                  max: max,
                  values: [ min, max ],
                  slide: function( event, ui ) {
                      $( "#date" ).val( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
                  },
                  stop: function(event, ui) {
                      var count = 0;
                      var shown = 0;
                      $("[data-start]").each( function () {
                          count += 1;
                          var d = parseInt($(this).attr('data-start'));
                          if (d < ui.values[0] || d > ui.values[1]) {
                              $(this).hide();
                          } else {
                              $(this).show();
                              shown += 1;
                          }
                      });
                      $("#shown").text(shown + " / " + count + " éléments affichés");
                      // FIXME: use navigation history to push filter into history
                  }
              });

              $( "#date" ).val( $( "#slider-range" ).slider( "values", 0 ) +
                                " - " + $( "#slider-range" ).slider( "values", 1 ) );
          }
      });
    </script>
{% endblock %}

{% block header %}<h1>{% with total=works|length %}{{ total }} oeuvre{{ total|pluralize }}{% if query_string %} correspondant à "{{ query_string }}"{% endif %}{% endwith %}</h1>
{% endblock %}

{% block margin %}
        {% with total=works|length %}
        <p>{{ total }} oeuvre{{ total|pluralize }} sélectionnée{{ total|pluralize }}</p>
        {% endwith %}
        <form>
          <label for="filter">Filtre</label>
          <input id="filter" type="text" name="q" value="{{ query_string }}" />
          <a href="javascript:resetFilter()"><img alt="Reset" title="Supprimer le filtre" src="{{ STATIC_URL }}reset.png" /></a>
        </form>

        <p>
          <label for="date">Date de création</label>
          <input type="text" id="date" style="border: 0" />
        </p>
        <div id="slider-range"></div>
        <div id="shown"></div>

        <p>Des facettes de sélection ici...</p>

        <div class="tagcloud">
          {% for tag in tagcloud_data %}
          <font size="{{ tag.weight|floatformat:0 }}"><a class="tag" href="?tag={{ tag }}">{{ tag }}</a></font>
          {% endfor %}
        </div>

{% endblock %}

{% block content %}
        {% for work in works %}
          {% with thumb=work.thumbnail %}
            <div class="work" data-start="{{ work.creation_date_start }}"><a href="{{ work.pk }}"><img class="{% if thumb.width > thumb.height %}landscape{% else %}portrait{% endif %}" alt="" title="{{ work }}" src="{% if thumb %}{{ thumb.url }}{% else %}{{ STATIC_URL }}unknown_thumbnail.png{% endif %}"></a></div>
          {% endwith %}
        {% endfor %}
      </div>
{% endblock %}
